# 🚀 Renderデプロイメントガイド

Voodoo Miracle BOTをRenderにデプロイする手順を説明します。

## 📋 目次

1. [Renderとは](#renderとは)
2. [デプロイ手順](#デプロイ手順)
3. [環境変数の設定](#環境変数の設定)
4. [デプロイ後の確認](#デプロイ後の確認)
5. [トラブルシューティング](#トラブルシューティング)
6. [無料プランの制限](#無料プランの制限)

---

## Renderとは

[Render](https://render.com)は、Node.js、Python、Dockerなど様々なアプリケーションをホスティングできるクラウドプラットフォームです。

### 🎁 無料プランの特徴

- ✅ 750時間/月の稼働時間
- ✅ 自動SSL証明書
- ✅ GitHubからの自動デプロイ
- ✅ 環境変数サポート
- ⚠️ 15分間アクティビティがないと自動スリープ
- ⚠️ スリープ後の起動に数秒かかる

---

## デプロイ手順

### ステップ1: Renderアカウントの作成

1. [https://render.com](https://render.com) にアクセス
2. 「**Get Started**」または「**Sign Up**」をクリック
3. **GitHubアカウントで登録**（推奨）
   - GitHubの認証画面が表示されたら許可
   - Renderがリポジトリにアクセスできるようになります

### ステップ2: 新しいWebサービスを作成

1. Renderダッシュボードで「**New +**」ボタンをクリック
2. 「**Web Service**」を選択

### ステップ3: GitHubリポジトリを接続

1. リポジトリ一覧から「**voodoo-miracle-bot**」を探す
   - リポジトリが表示されない場合：
     - 「**Configure account**」をクリック
     - Renderに権限を付与
2. 「**Connect**」ボタンをクリック

### ステップ4: サービスの設定

以下の設定を入力：

#### 基本設定

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| **Name** | `voodoo-miracle-bot` | サービス名（URLの一部になります） |
| **Region** | `Oregon (US West)` | 最寄りのリージョンを選択 |
| **Branch** | `main` | デプロイするブランチ |
| **Root Directory** | (空欄) | プロジェクトルート |
| **Runtime** | `Node` | Node.jsを選択 |

#### ビルド設定

| 設定項目 | 値 |
|---------|-----|
| **Build Command** | `npm install` |
| **Start Command** | `npm start` |

#### インスタンスタイプ

- **Free** プランを選択

### ステップ5: 環境変数の設定 🔑

「**Environment Variables**」セクションで「**Add Environment Variable**」をクリック：

#### 必須の環境変数

```
Key: GEMINI_API_KEY
Value: AIzaSyAsXFEmPq78gIPbLKaCjsmUKvDgrdwjSYo
```

```
Key: NODE_ENV
Value: production
```

```
Key: PORT
Value: 3000
```

### ステップ6: デプロイ実行 🎉

1. すべての設定を確認
2. 「**Create Web Service**」ボタンをクリック
3. Renderが自動的にビルドとデプロイを開始
4. デプロイログがリアルタイムで表示されます

#### デプロイの進行状況

- ✅ **Building**: 依存関係のインストール中
- ✅ **Deploying**: アプリケーションのデプロイ中
- ✅ **Live**: デプロイ完了！

### ステップ7: URLの確認

デプロイが完了すると、以下のようなURLが表示されます：

```
https://voodoo-miracle-bot.onrender.com
```

このURLをブラウザで開いて、アプリケーションが正常に動作することを確認してください。

---

## 環境変数の設定

### ダッシュボードから設定

1. サービスのページで「**Environment**」タブをクリック
2. 「**Add Environment Variable**」をクリック
3. Key と Value を入力
4. 「**Save Changes**」をクリック
5. 自動的に再デプロイが開始されます

### render.yaml を使用（推奨）

プロジェクトルートに`render.yaml`ファイルがあります：

```yaml
services:
  - type: web
    name: voodoo-miracle-bot
    runtime: node
    plan: free
    branch: main
    buildCommand: npm install
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: GEMINI_API_KEY
        sync: false
    healthCheckPath: /
    autoDeploy: true
```

**注意:** `GEMINI_API_KEY`は`sync: false`に設定されているため、Renderダッシュボードで手動で設定する必要があります。

---

## デプロイ後の確認

### ✅ チェックリスト

1. **サイトが正常に表示される**
   - デプロイされたURLにアクセス
   - ページが読み込まれることを確認

2. **祈祷機能が動作する**
   - 「シャーマンBOTに相談する」タブをクリック
   - 祈祷タイプを選択
   - メッセージを入力して送信
   - AIレスポンスが返ってくることを確認

3. **運勢機能が動作する**
   - "今日の運勢"タブをクリック
   - 運勢が表示されることを確認

4. **月の位相が表示される**
   - ページ上部に月の位相が表示されることを確認

5. **アクションボタンが動作する**
   - 資料請求ボタンでPDFが開くことを確認
   - LINE相談ボタンでLINEページが開くことを確認

---

## 自動デプロイ設定

Renderは自動的にGitHubリポジトリと連携します：

### 自動デプロイのトリガー

- **mainブランチへのpush** → 自動的に本番環境へデプロイ
- **その他のブランチ** → 手動デプロイまたは設定により自動デプロイ可能

### デプロイの流れ

```bash
# ローカルで変更をコミット
git add .
git commit -m "feat: 新機能を追加"

# mainブランチにプッシュ
git push origin main
```

→ Renderが自動的に検知してデプロイを開始

---

## ログの確認

### リアルタイムログ

1. サービスのページで「**Logs**」タブをクリック
2. リアルタイムでアプリケーションログを確認できます

### デプロイログ

1. 「**Events**」タブをクリック
2. 各デプロイの詳細ログを確認できます

---

## トラブルシューティング

### 問題1: デプロイが失敗する

**原因:** 依存関係のインストールエラー

**解決策:**
```bash
# ローカルで依存関係を再インストール
rm -rf node_modules package-lock.json
npm install

# 問題がなければコミット＆プッシュ
git add package-lock.json
git commit -m "fix: 依存関係を更新"
git push origin main
```

### 問題2: APIが動作しない

**原因:** 環境変数が設定されていない

**解決策:**
1. Renderダッシュボードで「Environment」タブを開く
2. `GEMINI_API_KEY`が正しく設定されているか確認
3. 値を修正したら自動的に再デプロイされます

### 問題3: サービスがスリープから復帰しない

**原因:** 無料プランの制限（15分間の非アクティブ後スリープ）

**解決策:**
- 最初のリクエスト時に30秒ほど待つ
- または、定期的にpingを送るサービスを使用（例: UptimeRobot）

### 問題4: 500 Internal Server Error

**原因:** サーバーエラー

**解決策:**
1. 「Logs」タブでエラーログを確認
2. エラー内容に応じて修正
3. 修正後、GitHubにプッシュして再デプロイ

### 問題5: ビルドが遅い

**原因:** 依存関係のインストールに時間がかかる

**解決策:**
- 初回デプロイは時間がかかります（5-10分）
- 2回目以降はキャッシュが使用され高速化されます

---

## 無料プランの制限

### 制限事項

| 項目 | 制限 |
|------|------|
| 稼働時間 | 750時間/月（約31日） |
| メモリ | 512MB |
| CPU | 共有CPU |
| 自動スリープ | 15分間非アクティブで休止 |
| 起動時間 | スリープ後30秒～1分 |
| カスタムドメイン | ❌ 不可（有料プランで可能） |
| SSL証明書 | ✅ 自動発行 |

### スリープ対策

無料プランでは、15分間リクエストがないとサービスがスリープします。

#### 対策1: UptimeRobotを使用

1. [UptimeRobot](https://uptimerobot.com)にサインアップ（無料）
2. 新しいモニターを作成：
   - Monitor Type: HTTP(s)
   - URL: あなたのRender URL
   - Monitoring Interval: 5分
3. これにより、5分ごとにpingが送られ、スリープを防げます

#### 対策2: 有料プランへのアップグレード

- **Starter プラン**: $7/月
  - スリープなし
  - より多いメモリとCPU
  - カスタムドメイン対応

---

## カスタムドメインの設定（有料プラン）

### ステップ1: ドメインの追加

1. サービスのページで「**Settings**」タブをクリック
2. 「**Custom Domains**」セクションで「**Add Custom Domain**」
3. ドメイン名を入力（例: `voodoo-miracle.com`）

### ステップ2: DNS設定

Renderが提供するCNAMEレコードをドメインのDNS設定に追加：

```
Type: CNAME
Name: @ または www
Value: voodoo-miracle-bot.onrender.com
```

### ステップ3: SSL証明書の自動発行

- Renderが自動的にSSL証明書を発行
- 通常、数分～数時間で完了

---

## パフォーマンス最適化

### 1. Node.jsバージョンの指定

`package.json`に追加：

```json
{
  "engines": {
    "node": "18.x"
  }
}
```

### 2. ヘルスチェックの設定

Renderは自動的にヘルスチェックを実行します：
- デフォルトパス: `/`
- 応答がない場合、サービスが再起動されます

### 3. 環境変数のキャッシュ

環境変数を変更すると自動的に再デプロイされます。
頻繁に変更する値は、データベースや外部設定サービスに保存することを検討してください。

---

## モニタリング

### Renderダッシュボード

1. **Metrics**: CPU、メモリ、リクエスト数などの統計
2. **Logs**: リアルタイムログとエラーログ
3. **Events**: デプロイ履歴とイベントログ

### 外部モニタリングサービス

- **UptimeRobot**: 稼働時間監視
- **New Relic**: アプリケーションパフォーマンス監視（有料）
- **Sentry**: エラートラッキング

---

## バックアップとロールバック

### 以前のデプロイメントにロールバック

1. 「**Events**」タブを開く
2. ロールバックしたいデプロイメントを探す
3. 「**Redeploy**」ボタンをクリック

---

## セキュリティ

### 環境変数の保護

- 環境変数はGitにコミットしない
- `.env`ファイルは`.gitignore`に追加済み
- Renderの環境変数は暗号化されて保存されます

### HTTPS

- すべてのRenderサービスは自動的にHTTPSが有効
- 無料のSSL証明書が自動発行されます

---

## コスト

### 無料プラン

- **月額**: $0
- **稼働時間**: 750時間/月
- **適している用途**: 
  - 個人プロジェクト
  - デモアプリケーション
  - 低トラフィックサイト

### Starterプラン

- **月額**: $7/月
- **稼働時間**: 無制限
- **スリープ**: なし
- **メモリ**: 512MB
- **適している用途**:
  - 小規模ビジネス
  - 常時稼働が必要なアプリ

---

## サポート

問題が発生した場合：

1. [Render Documentation](https://render.com/docs)を確認
2. [Render Community](https://community.render.com)で質問
3. プロジェクトのGitHubリポジトリでIssueを作成

---

## まとめ

### Renderのメリット

✅ セットアップが簡単  
✅ GitHubからの自動デプロイ  
✅ 無料プランあり  
✅ 自動SSL証明書  
✅ 環境変数サポート  
✅ リアルタイムログ  

### Renderのデメリット

⚠️ 無料プランは15分後にスリープ  
⚠️ スリープ後の起動に時間がかかる  
⚠️ カスタムドメインは有料プランのみ  

---

🎉 **Renderへのデプロイ完了！あなたのVoodoo Miracle BOTが稼働を開始しました！** 🎉
