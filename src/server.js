require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');
const { GoogleGenerativeAI } = require('@google/generative-ai');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());

// セキュリティ＆プライバシー保護ヘッダー
app.use((req, res, next) => {
  // 検索エンジンクロール防止
  res.setHeader('X-Robots-Tag', 'noindex, nofollow, noarchive, nosnippet');
  
  // プライバシー保護ヘッダー
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'no-referrer');
  res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');
  
  // キャッシュ無効化（プライバシー保護）
  res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');
  res.setHeader('Pragma', 'no-cache');
  res.setHeader('Expires', '0');
  
  next();
});

app.use(express.static('public'));

// Gemini AI初期化（APIキーがある場合のみ）
const DEMO_MODE = !process.env.GEMINI_API_KEY || process.env.GEMINI_API_KEY === 'test_key_placeholder';
let genAI = null;

if (!DEMO_MODE) {
  genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
}

console.log(`🔮 モード: ${DEMO_MODE ? 'デモモード（Gemini API不使用）' : 'Gemini API連携モード'}`);

// シャーマンの祈祷タイプ
const prayerTypes = {
  love: {
    name: '恋愛の祈祷',
    emoji: '💕',
    prompt: `あなたは優しいシャーマンです。恋愛の悩みを抱えている人に、温かく寄り添ってください。

【重要な指示】
1. まず「今まで本当によく頑張ってきましたね」「あなたの気持ちはとても純粋で素晴らしいです」など、相手の努力や気持ちを認める言葉から始めてください
2. 難しい言葉は使わず、中学生でもわかる簡単な日本語で書いてください
3. 具体的で実践しやすいアドバイスを3つ提供してください（例：「毎朝鏡を見て笑顔の練習をする」など）
4. 励ましの言葉を多く入れてください（「大丈夫」「あなたなら できる」など）
5. 短い文章で、読みやすくしてください

【構成】※必ずこの順番で書いてください
1. 【あなたへの言葉】相手の頑張りを認め、励ます（3-4行）
2. 【今のあなたの状態】今の気持ちに寄り添う（2-3行）
3. 【シャーマンからのアドバイス】具体的で簡単にできること3つ（箇条書き）
4. 【祈りの言葉】短くて温かい祝福の言葉（2-3行）
5. 【今日からできること】今すぐ始められる簡単な行動1つ（1-2行）`
  },
  wealth: {
    name: '金運の祈祷',
    emoji: '💰',
    prompt: `あなたは優しいシャーマンです。お金や仕事の悩みを抱えている人に、希望を与えてください。

【重要な指示】
1. まず「毎日本当にお疲れ様です」「あなたはとても頑張っています」など、相手の努力を認める言葉から始めてください
2. 難しい言葉は使わず、中学生でもわかる簡単な日本語で書いてください
3. 具体的で実践しやすいアドバイスを3つ提供してください（例：「財布をきれいに整理する」など）
4. 励ましの言葉を多く入れてください（「必ず良くなります」「あなたの価値は高い」など）
5. 短い文章で、読みやすくしてください

【構成】※必ずこの順番で書いてください
1. 【あなたへの言葉】相手の頑張りを認め、励ます（3-4行）
2. 【今のあなたの状態】今の状況に寄り添う（2-3行）
3. 【シャーマンからのアドバイス】具体的で簡単にできること3つ（箇条書き）
4. 【祈りの言葉】短くて温かい祝福の言葉（2-3行）
5. 【今日からできること】今すぐ始められる簡単な行動1つ（1-2行）`
  },
  health: {
    name: '健康の祈祷',
    emoji: '🌿',
    prompt: `あなたは優しいシャーマンです。体や心の不調で悩んでいる人に、癒しを与えてください。

【重要な指示】
1. まず「辛い中、よく耐えてきましたね」「あなたは十分頑張っています」など、相手の苦労を認める言葉から始めてください
2. 難しい言葉は使わず、中学生でもわかる簡単な日本語で書いてください
3. 具体的で実践しやすいアドバイスを3つ提供してください（例：「深呼吸を5回する」など）
4. 励ましの言葉を多く入れてください（「必ず良くなります」「無理しないでください」など）
5. 短い文章で、読みやすくしてください

【構成】※必ずこの順番で書いてください
1. 【あなたへの言葉】相手の頑張りを認め、励ます（3-4行）
2. 【今のあなたの状態】今の状態に寄り添う（2-3行）
3. 【シャーマンからのアドバイス】具体的で簡単にできること3つ（箇条書き）
4. 【祈りの言葉】短くて温かい祝福の言葉（2-3行）
5. 【今日からできること】今すぐ始められる簡単な行動1つ（1-2行）`
  },
  protection: {
    name: '厄除けの祈祷',
    emoji: '🛡️',
    prompt: `あなたは優しいシャーマンです。不安や恐怖を感じている人に、安心と守りを与えてください。

【重要な指示】
1. まず「不安な気持ち、よくわかります」「あなたは一人じゃありません」など、相手の不安を受け止める言葉から始めてください
2. 難しい言葉は使わず、中学生でもわかる簡単な日本語で書いてください
3. 具体的で実践しやすいアドバイスを3つ提供してください（例：「玄関に塩を置く」など）
4. 励ましの言葉を多く入れてください（「大丈夫」「守られています」など）
5. 短い文章で、読みやすくしてください

【構成】※必ずこの順番で書いてください
1. 【あなたへの言葉】相手の不安を受け止め、励ます（3-4行）
2. 【今のあなたの状態】今の気持ちに寄り添う（2-3行）
3. 【シャーマンからのアドバイス】具体的で簡単にできること3つ（箇条書き）
4. 【祈りの言葉】短くて温かい祝福の言葉（2-3行）
5. 【今日からできること】今すぐ始められる簡単な行動1つ（1-2行）`
  },
  general: {
    name: '総合的な祈祷',
    emoji: '🔮',
    prompt: `あなたは優しいシャーマンです。人生の様々な悩みを抱えている人に、希望と勇気を与えてください。

【重要な指示】
1. まず「毎日本当によく頑張っていますね」「あなたの努力は素晴らしいです」など、相手の頑張りを認める言葉から始めてください
2. 難しい言葉は使わず、中学生でもわかる簡単な日本語で書いてください
3. 具体的で実践しやすいアドバイスを3つ提供してください（例：「朝日を浴びる」など）
4. 励ましの言葉を多く入れてください（「きっと大丈夫」「あなたなら乗り越えられる」など）
5. 短い文章で、読みやすくしてください

【構成】※必ずこの順番で書いてください
1. 【あなたへの言葉】相手の頑張りを認め、励ます（3-4行）
2. 【今のあなたの状態】今の状況に寄り添う（2-3行）
3. 【シャーマンからのアドバイス】具体的で簡単にできること3つ（箇条書き）
4. 【祈りの言葉】短くて温かい祝福の言葉（2-3行）
5. 【今日からできること】今すぐ始められる簡単な行動1つ（1-2行）`
  }
};

// デモモード用の祈祷レスポンス生成
function generateDemoPrayerResponse(type, message, moonPhase) {
  const responses = {
    love: `【あなたへの言葉】
今まで本当によく頑張ってきましたね。恋愛で悩むのは、あなたが本気で誰かを大切に思っているからです。その気持ちは、とても純粋で素晴らしいものです。あなたは愛される価値がある人です。今の${moonPhase.phase}は、恋愛運が良い時期ですよ。

【今のあなたの状態】
今、あなたの心には優しいピンク色の光が灯っています。恋をしているあなたは、とても魅力的に輝いています。大丈夫、必ず良い方向に進んでいきます。

【シャーマンからのアドバイス】
今日から実践できる簡単なことを3つお伝えします：

・毎朝、鏡を見て自分に笑顔を向けて「私は素敵です」と言ってみましょう
・好きな人のことを考えながら、ピンク色のものを身近に置きましょう
・友達との楽しい時間を大切にしましょう。笑顔でいると運気が上がります

【祈りの言葉】
あなたに幸せな恋が訪れますように。あなたの優しさが、素敵な人に届きますように。あなたの笑顔が、誰かの心を温めますように。きっと大丈夫です。

【今日からできること】
今日は鏡を見て、自分に向かって笑顔を作ってみてください。それだけで、あなたの魅力が2倍になりますよ。`,
    
    wealth: `【あなたへの言葉】
毎日本当にお疲れ様です。お金のことで悩むのは、あなたが真面目に人生を考えているからです。あなたはとても頑張っています。その努力は、必ず報われます。今の${moonPhase.phase}は、金運が良くなる時期ですよ。

【今のあなたの状態】
今、あなたの周りには金色の光が集まり始めています。お金に対する不安は、少しずつ小さくなっていきます。必ず良くなります。信じてください。

【シャーマンからのアドバイス】
今日から実践できる簡単なことを3つお伝えします：

・財布の中を整理して、きれいにしましょう。お金は綺麗な場所が好きです
・毎日「ありがとう」と感謝の言葉を10回言いましょう。感謝は豊かさを呼びます
・小さな節約でも良いので、続けましょう。小さな積み重ねが大きくなります

【祈りの言葉】
あなたに豊かさが訪れますように。あなたの努力が報われますように。あなたの未来に、お金の心配がなくなりますように。必ず良くなります。

【今日からできること】
今日は財布の中を整理して、レシートなどを全部出しましょう。それだけで、金運が良くなり始めますよ。`,
    
    health: `【あなたへの言葉】
辛い中、よく耐えてきましたね。体や心が辛いのに、それでも毎日を過ごしているあなたは、本当に強い人です。あなたは十分頑張っています。無理しないでくださいね。今の${moonPhase.phase}は、体が回復しやすい時期ですよ。

【今のあなたの状態】
今、あなたの体は優しい緑色の光に包まれています。体が「休みたい」と言っています。その声を聞いてあげてください。必ず良くなります。

【シャーマンからのアドバイス】
今日から実践できる簡単なことを3つお伝えします：

・深呼吸を朝と夜に5回ずつしましょう。ゆっくり吸って、ゆっくり吐きます
・温かいお茶を飲んで、ほっとする時間を作りましょう
・早く寝ましょう。睡眠が一番の薬です。夜10時には布団に入りましょう

【祈りの言葉】
あなたの体が元気になりますように。あなたの心が穏やかになりますように。あなたの痛みが、少しずつ小さくなりますように。必ず良くなります。

【今日からできること】
今日は深呼吸を5回してみてください。鼻からゆっくり吸って、口からゆっくり吐きます。それだけで、体が少し楽になりますよ。`,
    
    protection: `【あなたへの言葉】
不安な気持ち、よくわかります。怖くて辛い思いをしているあなたは、とても頑張っています。あなたは一人じゃありません。ちゃんと守られています。今の${moonPhase.phase}は、悪いものを追い払う力が強い時期ですよ。

【今のあなたの状態】
今、あなたの周りには青い光の盾があります。悪いものは、あなたに近づけません。大丈夫です。必ず守られています。安心してください。

【シャーマンからのアドバイス】
今日から実践できる簡単なことを3つお伝えします：

・玄関に塩を小皿に入れて置きましょう。悪いものが入ってこなくなります
・外から帰ったら、手を洗いながら「悪いものは流れていく」と言いましょう
・部屋の窓を開けて、空気を入れ替えましょう。新しい空気が守ってくれます

【祈りの言葉】
あなたが守られますように。悪いものが、あなたから離れていきますように。あなたの心に、平和が訪れますように。大丈夫、守られています。

【今日からできること】
今日は玄関に塩を置いてみてください。小皿に少しで大丈夫です。それだけで、悪いものが入ってこなくなりますよ。`,
    
    general: `【あなたへの言葉】
毎日本当によく頑張っていますね。色々な悩みがあって大変だと思います。でも、あなたの努力は素晴らしいです。きっと良い方向に進んでいます。今の${moonPhase.phase}は、新しいスタートに良い時期ですよ。

【今のあなたの状態】
今、あなたの周りには虹色の光が輝いています。人生が良い方向に変わろうとしています。きっと大丈夫です。信じてください。

【シャーマンからのアドバイス】
今日から実践できる簡単なことを3つお伝えします：

・朝、太陽の光を少しでも浴びましょう。元気が出ます
・寝る前に、今日良かったことを1つ思い出しましょう。小さなことで大丈夫です
・「ありがとう」を1日10回言いましょう。幸せが増えます

【祈りの言葉】
あなたの人生が良くなりますように。あなたの悩みが、少しずつ小さくなりますように。あなたの未来に、幸せがたくさん訪れますように。必ず良くなります。

【今日からできること】
今日は朝、カーテンを開けて太陽の光を見てみてください。少し見るだけで大丈夫です。それだけで、心が少し軽くなりますよ。`
  };

  return responses[type] || responses.general;
}

// デモモード用の運勢レスポンス生成
function generateDemoFortuneResponse(moonPhase) {
  return `【今日のオーラの色】 🎨
輝く「インディゴブルー」
あなたのオーラは深い藍色に輝いています。これは直感力と洞察力が高まっているサインです。第三の目のチャクラが活性化し、宇宙からのメッセージを受け取りやすい状態です。スピリチュアルな成長の時期を迎えています。

【チャクラの状態】 🧘
第6チャクラ（眉間・第三の目）が強く活性化
直感と洞察力が冴え渡る日です。瞑想やイメージングを行うことで、さらにエネルギーが高まります。心を静かにして、内なる声に耳を傾けましょう。紫色のものを身につけると、チャクラのバランスが整います。

【守護天使のメッセージ】 👼
「愛する魂よ、あなたは正しい道を歩んでいます。今感じている不安や迷いは、成長のための試練です。私たちはいつもあなたのそばにいて、見守っています。信じて進みなさい。光と愛があなたを包んでいます。」

【全体運】 ⭐
★★★★☆（4/5）
${moonPhase.phase}のエネルギーが満ちる今日は、スピリチュアルな気づきに恵まれる特別な一日です。直感を信じて行動することで、素晴らしい展開が待っています。周りの人に優しさと愛を分かち合いましょう。

【恋愛運】 💕
★★★★★（5/5）
恋愛運が絶好調！ツインソウルやソウルメイトとの出会いの予感があります。既にパートナーがいる方は、魂のレベルでの深いつながりを感じられる日。愛の波動を高めることで、さらなる幸せが訪れます。ピンク色を身につけるとハートチャクラが開きます。

【金運】 💰
★★★☆☆（3/5）
金運は安定しています。宇宙の豊かさを信じる心が大切です。「私は豊かさを受け取る価値がある」とアファメーションを唱えましょう。感謝のエネルギーが、さらなる豊かさを引き寄せます。緑色の財布や小物が金運アップに効果的です。

【健康運】 🌿
★★★★☆（4/5）
心と体のバランスが良好です。今日は自然の中で過ごす時間を作ると、大地のエネルギーをチャージできます。瞑想やヨガ、深呼吸を取り入れることで、エネルギーの流れがスムーズになります。ハーブティーやアロマもおすすめです。

【今日のパワーストーン】 💎
アメジスト（紫水晶）
霊性を高め、直感力を強化するパワーストーンです。今日はアメジストを身につけるか、瞑想時に手に持つことで、第三の目のチャクラが活性化します。ネガティブなエネルギーを浄化し、心の平和をもたらしてくれます。

【ラッキーカラー・ナンバー】 🌈
ラッキーカラー：紫、藍色、シルバー
ラッキーナンバー：7、11、33
紫は霊性と変容の色。7は神秘と内省の数字。11はマスターナンバーで、スピリチュアルな目覚めを象徴します。これらを意識することで、宇宙のエネルギーと調和します。

【スピリチュアルアドバイス】 ✨
今日は朝の瞑想からスタートしましょう。5分間でも良いので、静かな時間を作り、呼吸に意識を向けてください。感謝の気持ちを持って一日を過ごし、出会う人すべてに愛の波動を送りましょう。夜は満月の光を浴びる（または想像する）ことで、エネルギーの浄化ができます。

🌙 宇宙のエネルギーがあなたを祝福しています 🌙
✨ 光と愛と共に ✨`;
}

// 月の満ち欠けを計算
function getMoonPhase() {
  const now = new Date();
  let year = now.getFullYear();
  let month = now.getMonth() + 1;
  const day = now.getDate();
  
  let c = 0, e = 0, jd = 0, b = 0;
  
  if (month < 3) {
    year--;
    month += 12;
  }
  
  ++month;
  c = 365.25 * year;
  e = 30.6 * month;
  jd = c + e + day - 694039.09;
  jd /= 29.5305882;
  b = parseInt(jd);
  jd -= b;
  b = Math.round(jd * 8);
  
  if (b >= 8) b = 0;
  
  const phases = ['新月', '三日月', '上弦の月', '十日夜の月', '満月', '寝待月', '下弦の月', '有明月'];
  const meanings = [
    '新しい始まりの時。願いを込めるのに最適です。',
    '成長と発展の時。新しいことを始めましょう。',
    '行動と実現の時。目標に向かって進みましょう。',
    '充実と拡大の時。努力が実を結びます。',
    '完成と達成の時。感謝の気持ちを捧げましょう。',
    '解放と手放しの時。不要なものを手放しましょう。',
    '調整と見直しの時。内省の時間を持ちましょう。',
    '浄化と準備の時。心を清めて次に備えましょう。'
  ];
  
  return {
    phase: phases[b],
    meaning: meanings[b],
    emoji: ['🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘'][b]
  };
}

// ルートページ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/index.html'));
});

// 祈祷API
app.post('/api/pray', async (req, res) => {
  try {
    const { type, message } = req.body;
    
    if (!type || !message) {
      return res.status(400).json({ error: 'Type and message are required' });
    }
    
    if (!prayerTypes[type]) {
      return res.status(400).json({ error: 'Invalid prayer type' });
    }
    
    const prayerConfig = prayerTypes[type];
    const moonPhase = getMoonPhase();
    
    let text;
    
    // デモモードの場合は、事前定義されたレスポンスを使用
    if (DEMO_MODE) {
      console.log('📝 デモモードで祈祷レスポンスを生成中...');
      text = generateDemoPrayerResponse(type, message, moonPhase);
    } else {
      // Gemini APIを使用
      console.log('🤖 Gemini APIで祈祷レスポンスを生成中...');
      const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
      
      const fullPrompt = `${prayerConfig.prompt}

現在の月の位相: ${moonPhase.emoji} ${moonPhase.phase}
月の意味: ${moonPhase.meaning}

ユーザーの願い・悩み: ${message}

上記を踏まえて、シャーマンとしてスピリチュアルなアドバイスと祈祷のメッセージを日本語で提供してください。以下の構成で回答してください：

1. 【霊視の結果】（あなたが見た霊的なビジョンや感じたエネルギー）
2. 【シャーマンからのアドバイス】（具体的な行動や心構え）
3. 【祈祷の言葉】（力強い祝福の言葉）
4. 【お守りの儀式】（日常でできる簡単な儀式やおまじない）

神秘的で心に響く言葉で語りかけてください。`;
      
      const result = await model.generateContent(fullPrompt);
      const response = await result.response;
      text = response.text();
    }
    
    res.json({
      success: true,
      type: prayerConfig.name,
      emoji: prayerConfig.emoji,
      moonPhase: moonPhase,
      message: text,
      demoMode: DEMO_MODE
    });
    
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ 
      error: 'Failed to generate prayer response',
      details: error.message 
    });
  }
});

// 今日の運勢API
app.get('/api/fortune', async (req, res) => {
  try {
    const moonPhase = getMoonPhase();
    const today = new Date().toLocaleDateString('ja-JP', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      weekday: 'long'
    });
    
    let text;
    
    // デモモードの場合は、事前定義されたレスポンスを使用
    if (DEMO_MODE) {
      console.log('📝 デモモードで運勢レスポンスを生成中...');
      text = generateDemoFortuneResponse(moonPhase);
    } else {
      // Gemini APIを使用
      console.log('🤖 Gemini APIで運勢レスポンスを生成中...');
      const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });
      
      const prompt = `あなたは宇宙のエネルギーを読み取るスピリチュアルマスターです。

今日の日付: ${today}
月の位相: ${moonPhase.emoji} ${moonPhase.phase}
月の意味: ${moonPhase.meaning}

今日のスピリチュアルリーディングを行い、以下の項目について神秘的でポジティブなメッセージを日本語で提供してください。

【今日のオーラの色】
（色の名前とその意味、今日のエネルギー状態）

【チャクラの状態】
（活性化しているチャクラ、その影響とバランスの取り方）

【守護天使のメッセージ】
（天使からの温かいメッセージとガイダンス）

【全体運】 ⭐
（今日の全体的な運勢とアドバイス）

【恋愛運】 💕
（恋愛に関する運勢と具体的なアドバイス）

【金運】 💰
（お金に関する運勢とアクションプラン）

【健康運】 🌿
（心と体の健康についてのアドバイス）

【今日のパワーストーン】 💎
（おすすめのパワーストーンとその効果）

【ラッキーカラー・ナンバー】 🌈
（ラッキーカラーとラッキーナンバー、その意味）

【スピリチュアルアドバイス】
（今日を最高の一日にするための具体的な行動）`;
      
      const result = await model.generateContent(prompt);
      const response = await result.response;
      text = response.text();
    }
    
    res.json({
      success: true,
      date: today,
      moonPhase: moonPhase,
      fortune: text,
      demoMode: DEMO_MODE
    });
    
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ 
      error: 'Failed to generate fortune',
      details: error.message 
    });
  }
});

// 祈祷タイプ一覧API
app.get('/api/prayer-types', (req, res) => {
  const types = Object.keys(prayerTypes).map(key => ({
    id: key,
    name: prayerTypes[key].name,
    emoji: prayerTypes[key].emoji
  }));
  
  res.json({ types });
});

// ヘルスチェックエンドポイント（Renderスリープ防止用）
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    mode: DEMO_MODE ? 'demo' : 'production'
  });
});

// サーバー起動
app.listen(PORT, () => {
  console.log(`🔮 Voodoo Miracle BOT is running on port ${PORT}`);
  console.log(`📍 http://localhost:${PORT}`);
});
